using SocketIO;
using SocketIOClient;
using SocketIOClient.Newtonsoft.Json;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Net;
using System.Net.Sockets;
using System.Text;
using UnityEngine;
using UnityEngine.Profiling;
using UnityEngine.UI;
using static SocketIOUnity;

public class NewSocket : MonoBehaviour
{
    public SocketIOUnity newSocket;

    public InputField IPInputField;
    public InputField PortInputField;

    public Text ConnectionLabel; // GUI button label

    public VehicleController[] VehicleControllers; // VehicleController references
    public WheelEncoder[] LeftWheelEncoders; // WheelEncoder references for left wheel
    public WheelEncoder[] RightWheelEncoders; // WheelEncoder references for right wheel
    public GPS[] IndoorPositioningSystems; // IPS references
    public IMU[] InertialMeasurementUnits; // IMU references
    public LIDAR[] LIDARUnits; // LIDAR references
    public Camera[] FrontCameras; // Vehicle front camera references

    private string lastDebugMessage = "";
    private string newConnectionLabelText = "";

    // Start is called before the first frame update
    private void Start()
    {
        newConnectionLabelText = ConnectionLabel.text;
        TryConnect();
    }

    private async void OnApplicationQuit()
    {
        if (newSocket != null && newSocket.Connected)
        {
            await newSocket.DisconnectAsync();
        }
        newSocket?.Dispose();
    }

    public void OnConnectButton()
    {
        if (newSocket == null || !newSocket.Connected)
        {
            TryConnect();
        }
        else
        {
            TryDisconnect();
        }
    }

    public void TryConnect()
    {
        if (newSocket != null)
        {
            Debug.Log("TryConnect(): Already initialized!");
            TryDisconnect();
        }

        // Initialize SocketIO
        var URI = new Uri("ws://" + IPInputField.text + ":" + PortInputField.text);
        newSocket = new SocketIOUnity(URI, new SocketIOOptions
        {
            EIO = SocketIOClient.EngineIO.V3
        });
        newSocket.JsonSerializer = new NewtonsoftJsonSerializer();

        // Normal SocketIO events
        newSocket.OnConnected += (sender, e) =>
        {
            lastDebugMessage = "Connect: " + e;
            Debug.Log(lastDebugMessage);

            newConnectionLabelText = "Disconnect";
        };
        newSocket.OnPing += (sender, e) =>
        {
            lastDebugMessage = "Ping: " + e;
            Debug.Log(lastDebugMessage);
        };
        newSocket.OnPong += (sender, e) =>
        {
            lastDebugMessage = "Pong: " + e.TotalMilliseconds;
            Debug.Log(lastDebugMessage);
        };
        newSocket.OnDisconnected += (sender, e) =>
        {
            lastDebugMessage = "Disconnect: " + e;
            Debug.Log(lastDebugMessage);

            newConnectionLabelText = "Connect";
        };
        newSocket.OnReconnectAttempt += (sender, e) =>
        {
            lastDebugMessage = $"{DateTime.Now} Reconnecting: attempt = {e}";
            Debug.Log(lastDebugMessage);
        };
        newSocket.OnReconnected += (sender, e) =>
        {
            lastDebugMessage = $"{DateTime.Now} Reconnected: {e}";
            Debug.Log(lastDebugMessage);
        };
        newSocket.OnReconnectError += (sender, e) =>
        {
            lastDebugMessage = $"{DateTime.Now} Reconnect error: {e}";
            Debug.Log(lastDebugMessage);
        };
        newSocket.OnReconnectFailed += (sender, e) =>
        {
            lastDebugMessage = $"{DateTime.Now} Reconnect failed: {e}";
            Debug.Log(lastDebugMessage);
        };
        newSocket.OnError += (sender, e) =>
        {
            lastDebugMessage = "Error: " + e;
            Debug.Log(lastDebugMessage);
        };

        // Socket Event Handlers
        newSocket.unityThreadScope = UnityThreadScope.LateUpdate;
        newSocket.OnUnityThread("Bridge", (response) =>
        {
            Dictionary<string, string> packetData = response.GetValue<Dictionary<string, string>>();

            if (VehicleControllers.Length != 0)
            {
                for (int i = 0; i < VehicleControllers.Length; i++)
                {
                    String vehicleID = "V" + (i + 1).ToString() + " ";

                    if (VehicleControllers[i].CurrentDrivingMode == 1)
                    {
                        VehicleControllers[i].CurrentThrottle = float.Parse(packetData[vehicleID + "Throttle"]); // Set throttle
                        VehicleControllers[i].CurrentSteeringAngle = float.Parse(packetData[vehicleID + "Steering"]); // Set steering angle
                    }
                }
            }
        });

        Debug.Log("Connecting...");
        newSocket.Connect();
    }

    public void TryDisconnect()
    {
        Debug.Log("Disconnecting...");

        // Stop race conditions
        SocketIOUnity tempSocket = newSocket;
        newSocket = null;

        if (tempSocket != null && tempSocket.Connected)
        {
            tempSocket.Disconnect();
        }
        
        tempSocket?.Dispose(); // syntactic sugar
    }

    // this func should be async to not block
    private bool sendingPacket = false;

    private StringBuilder LIDARRangeArray = new StringBuilder(2048);
    private StringBuilder LIDARIntensityArray = new StringBuilder(2048);

    private async void FixedUpdate()
    {
        // Can only update text in main thread
        ConnectionLabel.text = newConnectionLabelText;

        if (sendingPacket || newSocket == null || !newSocket.Connected)
            return; // Skip until last packet was sent

        sendingPacket = true;

        try
        {
            Profiler.BeginSample("SocketIO_PacketProcessing");
            Dictionary<string, string> packetData = new Dictionary<string, string>(); // Create new data dictionary
                                                                                      // Read data from vehicles
            if (VehicleControllers.Length != 0)
            {
                for (int i = 0; i < VehicleControllers.Length; i++) // Assumed that VehicleControllers.Length >= others
                {
                    String vehicleID = "V" + (i + 1).ToString() + " ";

                    // Todo, figure out a better way to pack this data into json format
                    // Cache vehicle IDs and dict keys using arrays compiled at start of scene
                    packetData[vehicleID + "Throttle"] = VehicleControllers[i].CurrentThrottle.ToString("F3"); // Get throttle
                    packetData[vehicleID + "Steering"] = VehicleControllers[i].CurrentSteeringAngle.ToString("F3"); // Get steering angle
                    packetData[vehicleID + "Encoder Ticks"] = LeftWheelEncoders[i].Ticks.ToString() + " " + RightWheelEncoders[i].Ticks.ToString(); // Get encoder ticks
                    packetData[vehicleID + "Encoder Angles"] = LeftWheelEncoders[i].Angle.ToString("F3") + " " + RightWheelEncoders[i].Angle.ToString("F3"); // Get encoder angles
                    packetData[vehicleID + "Position"] = IndoorPositioningSystems[i].CurrentPosition[0].ToString("F3") + " " + IndoorPositioningSystems[i].CurrentPosition[1].ToString("F3") + " " + IndoorPositioningSystems[i].CurrentPosition[2].ToString("F3"); // Get vehicle position
                    packetData[vehicleID + "Orientation Quaternion"] = InertialMeasurementUnits[i].CurrentOrientationQuaternion[0].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentOrientationQuaternion[1].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentOrientationQuaternion[2].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentOrientationQuaternion[3].ToString("F3"); // Get vehicle orientation (Quaternion)
                    packetData[vehicleID + "Orientation Euler Angles"] = InertialMeasurementUnits[i].CurrentOrientationEulerAngles[0].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentOrientationEulerAngles[1].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentOrientationEulerAngles[2].ToString("F3"); // Get vehicle orientation (Euler Angles)
                    packetData[vehicleID + "Angular Velocity"] = InertialMeasurementUnits[i].CurrentAngularVelocity[0].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentAngularVelocity[1].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentAngularVelocity[2].ToString("F3"); // Get angular velocity of the vehicle
                    packetData[vehicleID + "Linear Acceleration"] = InertialMeasurementUnits[i].CurrentLinearAcceleration[0].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentLinearAcceleration[1].ToString("F3") + " " + InertialMeasurementUnits[i].CurrentLinearAcceleration[2].ToString("F3"); // Get linear acceleration of the vehicle
                    packetData[vehicleID + "LIDAR Scan Rate"] = LIDARUnits[i].CurrentScanRate.ToString("F3"); // Get LIDAR scan rate

                    Profiler.BeginSample("SocketIO_LidarProcessing");
                    var currentRangeArray = LIDARUnits[i].CurrentRangeArray;
                    var currentIntensityArray = LIDARUnits[i].CurrentIntensityArray;
                    int currentLIDARLength = currentRangeArray.Length;

                    if (currentRangeArray[currentLIDARLength - 1] != null) //fixme
                    {
                        LIDARRangeArray.AppendJoin(" ", currentRangeArray);
                        LIDARIntensityArray.AppendJoin(" ", currentIntensityArray);
                    }
                    packetData[vehicleID + "LIDAR Range Array"] = LIDARRangeArray.ToString(); // Get LIDAR range array
                    packetData[vehicleID + "LIDAR Intensity Array"] = LIDARIntensityArray.ToString(); // Get LIDAR intensity array
                    LIDARRangeArray.Clear(); // Reset LIDAR range array for next measurement
                    LIDARIntensityArray.Clear(); // Reset LIDAR intensity array for next measurement
                    Profiler.EndSample();

                    // Spoofed
                    packetData[vehicleID + "Front Camera Image"] = Convert.ToBase64String(new byte[] {
                        0xFF,0xD8,0xFF,0xE0,0x00,0x10,0x4A,0x46,0x49,0x46,0x00,0x01,0x01,0x01,0x01,0x2C,0x01,0x2C,0x00,0x00,0xFF,0xDB,0x00,0x43,0x00,0x10,0x0B,0x0C,0x0E,0x0C,0x0A,0x10,0x0E,0x0D,0x0E,0x12,0x11,0x10,0x13,0x18,0x28,0x1A,0x18,0x16,0x16,0x18,0x31,0x23,0x25,0x1D,0x28,0x3A,0x33,0x3D,0x3C,0x39,0x33,0x38,0x37,0x40,0x48,0x5C,0x4E,0x40,0x44,0x57,0x45,0x37,0x38,0x50,0x6D,0x51,0x57,0x5F,0x62,0x67,0x68,0x67,0x3E,0x4D,0x71,0x79,0x70,0x64,0x78,0x5C,0x65,0x67,0x63,0xFF,0xDB,0x00,0x43,0x01,0x11,0x12,0x12,0x18,0x15,0x18,0x2F,0x1A,0x1A,0x2F,0x63,0x42,0x38,0x42,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0xFF,0xC2,0x00,0x11,0x08,0x00,0x48,0x00,0x80,0x03,0x01,0x11,0x00,0x02,0x11,0x01,0x03,0x11,0x01,0xFF,0xC4,0x00,0x1A,0x00,0x00,0x02,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x03,0x04,0x05,0x06,0xFF,0xC4,0x00,0x18,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x03,0x04,0xFF,0xDA,0x00,0x0C,0x03,0x01,0x00,0x02,0x10,0x03,0x10,0x00,0x00,0x01,0xAD,0x2C,0x30,0xD4,0x37,0x74,0xF1,0xD6,0x8E,0xF2,0xBE,0x4B,0xF4,0x72,0xC3,0x0A,0x3D,0x4C,0x18,0x99,0x79,0xC3,0x45,0x81,0xA9,0xE8,0xF2,0xEC,0xAC,0x07,0x4C,0x60,0x30,0x28,0x38,0xBD,0xF5,0x86,0x4A,0x39,0x4A,0xB4,0x8E,0x05,0x9D,0x6C,0xBD,0x26,0xAC,0x6D,0x72,0x43,0x57,0x47,0x39,0x20,0x03,0x34,0x72,0x3D,0x1A,0x8F,0x1C,0xE4,0x8C,0x15,0x08,0x5A,0x74,0xF3,0x3D,0x6A,0xA1,0x88,0x60,0x00,0x66,0x8E,0x3F,0x6A,0xF9,0x4E,0x79,0x94,0x89,0x0D,0x3A,0x19,0x9E,0xBD,0x79,0xA5,0x80,0x8C,0x00,0x09,0x5B,0xE7,0xB6,0x39,0xCA,0x8A,0x84,0x51,0xA6,0xEC,0xBD,0x82,0xD4,0x30,0x00,0x00,0x33,0x9E,0x6A,0xCD,0x12,0xD4,0x24,0x91,0x8C,0xD0,0x7B,0x15,0x00,0x00,0x88,0x84,0x67,0x4F,0x2E,0x44,0xE9,0x13,0x31,0x1C,0xD5,0xD2,0x7A,0x30,0x02,0xD4,0x88,0x80,0x0C,0xE7,0x0E,0x92,0xDD,0x2D,0x29,0x9C,0x46,0x94,0xA4,0xD8,0x59,0x63,0x2B,0xA9,0x42,0x02,0x2A,0x88,0xAD,0x69,0x09,0x62,0x88,0xFF,0xC4,0x00,0x26,0x10,0x00,0x02,0x02,0x02,0x00,0x04,0x07,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x00,0x03,0x11,0x12,0x04,0x14,0x21,0x31,0x10,0x13,0x20,0x22,0x33,0x34,0x41,0x30,0x32,0xFF,0xDA,0x00,0x08,0x01,0x01,0x00,0x01,0x05,0x02,0xFD,0x2B,0xD1,0xD4,0x64,0x88,0xB5,0xC5,0x18,0x00,0x45,0xEF,0x8F,0x7B,0x8C,0xC7,0x96,0x7A,0x53,0x4D,0xB4,0x59,0xE5,0x57,0x3C,0xAA,0xE6,0xA9,0x34,0x59,0xA2,0xCD,0x56,0x6A,0xB2,0xE5,0x02,0xA7,0x8D,0x9C,0x95,0x61,0xE8,0xA0,0xFB,0x99,0x76,0x27,0x68,0x36,0xCF,0xE8,0xF4,0x71,0x1F,0x0B,0x0C,0x86,0x4C,0xC2,0xA2,0x18,0x7C,0x28,0xFF,0x00,0x7F,0xC3,0x88,0xF8,0x4B,0x60,0x33,0x86,0x8E,0xD1,0xA6,0xBE,0xC9,0x47,0xC9,0x2D,0x6C,0xA3,0xFB,0x4B,0xF4,0x2F,0xD0,0xB7,0x42,0xDD,0x0B,0x74,0x3C,0x4F,0xD7,0xCE,0x57,0xB8,0xD6,0x3C,0xC7,0x4E,0xD2,0x8F,0x96,0x79,0x6B,0x34,0x52,0x74,0x52,0x74,0x5C,0xE8,0xB9,0xD1,0x73,0xA2,0xE7,0x8A,0xFA,0xC8,0xC5,0x4E,0x90,0xA3,0x41,0x5C,0x23,0x02,0xDE,0xF4,0x7C,0xDE,0x93,0xDB,0xF6,0x71,0x5F,0x5B,0xF1,0x2C,0x29,0x2B,0xB0,0x5B,0x06,0xAC,0x6F,0xB0,0x0F,0x0A,0xAC,0xD6,0xCE,0x7E,0x99,0xCF,0xD3,0x39,0xEA,0x67,0x34,0x93,0x9C,0xAA,0x73,0xB5,0x4E,0x76,0xA9,0xCE,0xD5,0x2F,0xE2,0x91,0xEA,0x39,0x30,0x77,0xA8,0xEA,0xF5,0x1D,0x58,0xF7,0x8C,0xAA,0x82,0x04,0x30,0x2A,0xCB,0x21,0x59,0xA6,0x1B,0x4C,0x1F,0x2C,0xCD,0x09,0x9A,0x6D,0x31,0x35,0xE8,0x41,0x13,0x06,0x6A,0x67,0xFF,0xC4,0x00,0x1B,0x11,0x00,0x01,0x04,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x10,0x11,0x30,0x50,0x20,0x31,0x41,0xFF,0xDA,0x00,0x08,0x01,0x03,0x01,0x01,0x3F,0x01,0x8C,0xDB,0x9E,0xA6,0xEF,0x9E,0x17,0xC7,0xFF,0xC4,0x00,0x24,0x11,0x00,0x02,0x02,0x01,0x03,0x02,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x11,0x10,0x12,0x20,0x21,0x03,0x41,0x22,0x30,0x31,0x32,0x50,0x61,0x71,0xFF,0xDA,0x00,0x08,0x01,0x02,0x01,0x01,0x3F,0x01,0xCC,0xAD,0xC4,0xF1,0x1D,0x3F,0x69,0x4C,0x82,0xE4,0x9D,0xD8,0x93,0xC7,0x51,0x14,0xCE,0xD8,0x5B,0x2D,0x96,0xCD,0x4C,0xB6,0x5B,0x2D,0x9A,0x9E,0x27,0x2A,0x35,0x32,0xF8,0x2C,0x58,0x4E,0x8E,0x0E,0x0F,0xDD,0xCF,0xB0,0xF1,0x78,0x8F,0x97,0x3F,0x4D,0xB1,0xCA,0xED,0xBD,0x7D,0x93,0x69,0xED,0x5F,0x39,0x58,0xAC,0xFF,0x00,0xFF,0xC4,0x00,0x28,0x10,0x00,0x02,0x01,0x02,0x03,0x08,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x10,0x11,0x21,0x31,0x41,0x12,0x20,0x22,0x32,0x42,0x61,0x91,0xB1,0x30,0x51,0x71,0x72,0x33,0xFF,0xDA,0x00,0x08,0x01,0x01,0x00,0x06,0x3F,0x02,0xA6,0x75,0x75,0xB9,0x7D,0xF8,0xE3,0xB5,0x73,0x95,0x1F,0xE7,0x1F,0x07,0x24,0x7C,0x1C,0xA8,0xE5,0x47,0x2A,0x32,0x46,0x48,0x6D,0x25,0x4C,0x15,0xCC,0x56,0xE4,0x3F,0x45,0x44,0x70,0xEE,0xCA,0x98,0x16,0xDC,0x87,0xF5,0xF0,0xCA,0x97,0x95,0x6F,0x48,0xFF,0x00,0x4A,0x92,0x92,0x59,0x3C,0xEE,0x4A,0x72,0xE2,0x8F,0xA2,0x52,0x7C,0x51,0xF4,0x39,0x3E,0x25,0xE8,0x72,0x7C,0x4B,0xD0,0xE4,0xF8,0x97,0xA1,0xC9,0xF1,0x2F,0x44,0x87,0xBD,0x0F,0xD5,0x4E,0x54,0x5E,0xC8,0xBD,0x91,0x7B,0x22,0xF6,0x45,0xEC,0x8B,0xD9,0x13,0x31,0xC8,0xBC,0x5E,0x14,0xC6,0xB0,0xFD,0x5F,0x0C,0xE9,0x74,0x61,0x99,0x84,0x91,0xB3,0x1A,0x45,0xBD,0x19,0xD5,0xE0,0xEA,0xF0,0x75,0x78,0x32,0x97,0x83,0x53,0x53,0x53,0xAB,0xC1,0x28,0x46,0xFB,0x4F,0xB1,0xDF,0x53,0xB1,0x9E,0x65,0xDB,0xB5,0x7E,0xD9,0x91,0x8E,0x08,0xC0,0xC0,0x52,0x15,0xF5,0x36,0x7E,0xCD,0x9D,0x4B,0x6A,0x8F,0xC3,0x6A,0x9D,0xAB,0xFF,0xC4,0x00,0x27,0x10,0x00,0x03,0x00,0x02,0x02,0x01,0x02,0x06,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x11,0x21,0x31,0x41,0x51,0x71,0x10,0x61,0x81,0x91,0xA1,0xC1,0xF0,0xF1,0x20,0x30,0xB1,0xD1,0xFF,0xDA,0x00,0x08,0x01,0x01,0x00,0x01,0x3F,0x21,0x5F,0xE4,0x63,0x58,0x67,0xDD,0x3E,0x91,0xA1,0x2E,0xC4,0x6D,0xB2,0x09,0x0C,0xE9,0x8B,0x86,0x07,0xCC,0x85,0xAE,0xAB,0x7E,0x04,0xC2,0x13,0x3A,0x1A,0x7D,0x1C,0x7A,0xA2,0xB3,0x23,0x25,0xEC,0x36,0xA8,0xE3,0xE0,0xFD,0x6C,0x87,0xFC,0x86,0x69,0xF4,0x4F,0xD2,0x9F,0xA0,0x3F,0x54,0x7E,0xA8,0x44,0x93,0x5E,0xC2,0xE1,0x0A,0xF0,0x4C,0xD0,0xF1,0xEB,0x83,0xF6,0xFF,0x00,0xA7,0x12,0x89,0x6C,0x64,0xEF,0x73,0xCE,0x4D,0xA6,0xB9,0x3D,0xA6,0xFE,0x03,0x37,0xB5,0x3F,0x83,0x25,0x63,0xE0,0x26,0xB3,0xC4,0x4B,0x56,0x8B,0x1B,0x5C,0x09,0x34,0xE8,0x87,0xF9,0x4F,0xE9,0x8C,0xEA,0xE0,0x5D,0xF6,0x2C,0xA6,0x7C,0x17,0x71,0x60,0xCB,0x91,0x57,0x90,0x47,0xE7,0x3B,0xF4,0x54,0x39,0xC3,0xDE,0x42,0xFD,0x48,0x64,0xA7,0x53,0x39,0xC8,0x49,0xFD,0x3C,0xE4,0x2C,0xFF,0x00,0xC5,0xC8,0x59,0xFF,0x00,0x8B,0x90,0x93,0x35,0x7D,0xE4,0x3A,0xBF,0x13,0xEE,0x5B,0x8B,0x48,0x6B,0x63,0xC1,0x9F,0xC3,0xB6,0x64,0xE2,0x2D,0x06,0xA8,0xFC,0xD7,0x7E,0x8D,0xAD,0xB6,0xC6,0xF7,0x81,0xD4,0x39,0xF7,0x07,0x50,0xE7,0xDC,0x1B,0x68,0xE7,0xDC,0x1B,0x29,0x6E,0xE0,0xD9,0x4B,0x77,0x06,0xCA,0x5B,0xB8,0x71,0x37,0x3E,0xE6,0x14,0xCB,0x68,0xC9,0x65,0xB7,0x1E,0x85,0x8B,0x3E,0x84,0x48,0x7F,0x25,0xDF,0xF2,0xD9,0x0E,0x43,0xB1,0xEF,0x67,0xD0,0x7D,0xCD,0xEC,0x93,0x44,0x3A,0xCE,0x6F,0x26,0x29,0x1A,0xE8,0xC7,0x81,0x87,0xD2,0x2A,0x32,0xBE,0x5F,0x46,0xC4,0x2F,0x61,0x0D,0x9E,0xFF,0x00,0xA1,0x96,0x71,0x03,0x5E,0xC1,0x27,0x1C,0xBF,0x07,0xE3,0x46,0x3B,0xAF,0x81,0xA6,0x3D,0x1E,0x98,0x5D,0x12,0x62,0x87,0x67,0x7E,0xC6,0x87,0xBD,0xBE,0x41,0x2E,0x71,0x51,0xAA,0xDE,0x05,0x56,0xA4,0xC7,0xB9,0x93,0x3F,0x48,0x46,0xFD,0xC4,0x72,0x87,0x5F,0x3F,0x99,0x65,0x79,0x4D,0x15,0x38,0xB6,0x4A,0x97,0xC4,0x39,0x63,0xF0,0x16,0x6A,0xB7,0xA2,0x86,0x47,0x6F,0x96,0x8B,0x26,0xF2,0x31,0x33,0x75,0xA3,0xC7,0x22,0x77,0xA3,0xF0,0x37,0x54,0xAE,0xB4,0x77,0x99,0x54,0x86,0xA7,0x1A,0x32,0x48,0x7F,0xFF,0xDA,0x00,0x0C,0x03,0x01,0x00,0x02,0x00,0x03,0x00,0x00,0x00,0x10,0x08,0xB8,0xC3,0x90,0x29,0x35,0xC2,0x06,0xB9,0x2E,0x44,0x37,0x74,0x7E,0xC0,0x18,0x6A,0x24,0x62,0x08,0x00,0x1A,0x71,0x20,0xA2,0x4A,0x49,0x22,0xFE,0x6D,0xE2,0x00,0x00,0x10,0xA4,0xD1,0xE0,0x00,0x20,0x1D,0x3E,0x94,0x80,0x4F,0xFB,0xFE,0x89,0x60,0x6D,0x77,0x7B,0x7B,0x42,0x9F,0xFF,0xC4,0x00,0x20,0x11,0x00,0x02,0x01,0x04,0x03,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x11,0x10,0x20,0x21,0x31,0x30,0x41,0x51,0x61,0x71,0xC1,0xFF,0xDA,0x00,0x08,0x01,0x03,0x01,0x01,0x3F,0x10,0xA2,0xA2,0x48,0x74,0x47,0x63,0x5C,0x89,0x24,0x96,0x4B,0x13,0x74,0x6E,0xE4,0xF0,0x60,0xC1,0xF6,0x3B,0x15,0x36,0x35,0x0E,0x39,0x50,0xC6,0xE6,0xFD,0x13,0xC5,0xF8,0x35,0x3A,0x3D,0x2F,0x0D,0xE5,0x78,0x6F,0x28,0xDE,0x51,0xBC,0x88,0x6E,0x92,0x2B,0x5E,0x77,0xC7,0x34,0x5C,0xAE,0x89,0x5D,0x24,0x92,0x49,0x24,0x8F,0x22,0x59,0x1A,0x44,0x55,0x39,0xA3,0x12,0x36,0xBA,0xBF,0x6F,0x93,0xB8,0x24,0x92,0x4F,0xFF,0xC4,0x00,0x22,0x11,0x00,0x03,0x01,0x00,0x01,0x04,0x01,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x11,0x21,0x61,0x10,0x20,0x31,0x41,0x51,0x30,0x40,0x81,0x91,0xB1,0xFF,0xDA,0x00,0x08,0x01,0x02,0x01,0x01,0x3F,0x10,0x10,0xB1,0x90,0x07,0xE9,0x04,0x75,0x4E,0x01,0x8B,0x68,0x56,0x68,0x85,0x32,0x0F,0xC2,0x18,0xDA,0x87,0x10,0xD3,0x31,0x8B,0xD8,0x95,0xE1,0x9C,0xEC,0xE4,0x39,0x8E,0x63,0x98,0x48,0xDA,0x37,0x52,0xFC,0x0C,0x78,0x86,0x4F,0xC8,0x58,0xD7,0xA4,0xCC,0x49,0x87,0x97,0x0F,0x41,0xA4,0xBC,0x76,0x31,0xA0,0x66,0xDD,0x62,0x74,0xA9,0x3E,0xA1,0x98,0x41,0x77,0xBC,0x9B,0xE5,0xAF,0xE8,0xB3,0xF6,0x2C,0xC7,0xF2,0x2C,0xCE,0x45,0x98,0x2C,0xC1,0x66,0x08,0x9B,0x82,0x22,0x5D,0xAE,0x97,0x55,0x9E,0x05,0x82,0xC1,0x60,0xB0,0x58,0x2C,0xFB,0xC8,0x42,0x10,0x84,0x16,0x0C,0xA5,0xEB,0x3A,0x42,0x09,0x3F,0x7D,0xEC,0x4E,0x88,0x43,0xFF,0xC4,0x00,0x28,0x10,0x01,0x00,0x02,0x02,0x01,0x03,0x02,0x06,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x11,0x21,0x31,0x41,0x51,0x61,0x71,0x81,0xA1,0x10,0x91,0xB1,0xD1,0xF0,0xF1,0x20,0xC1,0xE1,0x30,0xFF,0xDA,0x00,0x08,0x01,0x01,0x00,0x01,0x3F,0x10,0xDB,0xCD,0x88,0x05,0x55,0x5B,0x43,0x8C,0xCE,0x6D,0x9D,0x83,0xCB,0xE9,0x10,0x01,0x61,0x85,0x66,0xCE,0xB1,0x78,0x7A,0xD1,0x70,0xF4,0x0B,0x6B,0xE5,0x00,0x59,0x07,0x1A,0xC1,0x5C,0xCB,0xBB,0x06,0xC2,0xBE,0xB7,0x07,0x20,0x07,0x87,0xD2,0x7C,0xFC,0xFA,0x46,0x4D,0x24,0xAE,0x25,0xCD,0xBE,0x52,0xBE,0x02,0x29,0xA9,0x26,0x79,0x35,0xA9,0x68,0x2E,0x84,0xD4,0x5F,0x69,0xF8,0x74,0x86,0xB0,0xF8,0xFB,0x50,0x30,0x2D,0x4C,0x15,0x9F,0xAA,0xCF,0xD2,0xE7,0xEA,0xF3,0xF5,0x78,0x4A,0x88,0xA6,0x98,0xC9,0x11,0x6C,0x6E,0xFD,0xA0,0xE5,0xAE,0x68,0x5A,0x85,0x20,0x0E,0xC8,0xFF,0x00,0x71,0x76,0x97,0x08,0xD9,0x58,0xAB,0xD9,0x15,0x4D,0x11,0x68,0xB4,0x6C,0xD7,0x47,0xBC,0xA2,0xB0,0x94,0xB0,0x9E,0x87,0xA4,0x18,0x76,0xBB,0xA8,0xD9,0x4F,0xBD,0xD4,0xA4,0x48,0x17,0x8E,0x86,0x1A,0xDA,0x8C,0x67,0x9F,0xE0,0x83,0x4A,0x02,0xEF,0xC9,0x0C,0x2D,0xD0,0x7C,0xCA,0x21,0x01,0xAC,0x43,0x59,0x7F,0x24,0x1C,0xA7,0xA3,0x50,0x69,0x80,0x9D,0x2B,0xE0,0xC0,0xF4,0xFA,0xE7,0xFC,0x74,0x50,0xE0,0xB5,0xC9,0x18,0xD4,0x45,0x00,0xBC,0xFE,0x10,0x4E,0x4C,0xAC,0x52,0x59,0x52,0x3A,0xCC,0x5B,0xFA,0x92,0xE8,0x0D,0x94,0xB9,0xB4,0xD3,0xEE,0xFB,0x3E,0x18,0x65,0x41,0x51,0xB0,0x30,0x43,0x30,0x00,0x28,0x54,0x03,0x34,0x7C,0xDE,0xB0,0x45,0x09,0x6C,0x54,0x40,0xC0,0x7B,0xF5,0x82,0x18,0xB6,0xC5,0x46,0xB4,0x1E,0xF0,0xC0,0x15,0x1C,0x54,0x6B,0x55,0xEF,0x04,0x41,0x11,0xB2,0xBD,0x9A,0xF7,0x86,0x38,0x06,0x4A,0xF6,0x2A,0x11,0x4D,0x50,0xFB,0x22,0x3A,0xB5,0x1B,0x94,0x00,0x0B,0x9A,0xC7,0x88,0x13,0x78,0x0D,0x9D,0x93,0x1D,0xAD,0xAE,0x35,0x02,0x68,0xBE,0xB1,0xB2,0xE2,0xF3,0x17,0xE1,0x71,0xF8,0x6E,0xC7,0x04,0x66,0x38,0x59,0x45,0x59,0x63,0x51,0xCA,0xCA,0x2A,0xCA,0xCD,0x47,0x6B,0x28,0xAB,0x2B,0x22,0xF4,0x9B,0x76,0xCA,0xE5,0xBE,0x9B,0x76,0xCA,0xE5,0xB6,0xAF,0x76,0xCA,0xE5,0xF0,0x86,0x8A,0x12,0xF8,0x46,0x20,0x23,0x5D,0x72,0x08,0xE9,0x4C,0x7F,0x49,0xA4,0x08,0x71,0x18,0xA1,0x61,0xD5,0x48,0xDE,0x28,0x51,0xF3,0x01,0xCB,0x15,0xCF,0x88,0xFF,0x00,0x3B,0x87,0xF2,0xBE,0x42,0x35,0xC4,0xB4,0xCC,0xA3,0xE7,0x1A,0x84,0xD0,0xE0,0xAB,0x79,0xC4,0x69,0xD4,0xAE,0xBC,0x22,0x2C,0xA4,0x2F,0x4D,0xBF,0x6F,0x59,0x9C,0x46,0xA1,0x78,0xFB,0x3C,0xC3,0xD3,0x32,0xD0,0xBC,0x76,0x66,0x09,0x35,0xD9,0x6D,0x75,0x94,0x29,0xAF,0xE8,0x3C,0xC5,0x55,0xAA,0xBD,0xE3,0x52,0xC5,0x9B,0xA1,0x16,0x0A,0xD5,0x1E,0x7F,0xD4,0x41,0x46,0xA9,0xB3,0xF7,0x81,0x96,0x57,0x41,0xFE,0xA6,0x9C,0xF6,0xA7,0xDE,0x34,0x8F,0x10,0x48,0xBE,0xF0,0x6B,0xE6,0x6C,0xAD,0xFD,0x62,0x34,0x5F,0x92,0x1A,0x3D,0xE0,0x88,0x58,0xAD,0x07,0xC6,0x65,0x48,0xA2,0xB4,0x69,0x1E,0xBD,0xA6,0x3F,0x60,0x61,0x8C,0x33,0x15,0x8A,0xAF,0xF1,0xDA,0x0F,0xD8,0xA5,0x00,0x27,0x5C,0x76,0x8F,0x41,0x18,0x05,0xB7,0xD3,0x11,0x83,0x69,0x57,0x77,0xF0,0xBC,0x87,0x2C,0x4C,0x11,0x16,0xA4,0x5F,0x0D,0xB7,0x2C,0x28,0xDC,0x38,0xFC,0x7F,0x92,0xF8,0xD6,0x55,0xEF,0x05,0x73,0xE9,0x2C,0x27,0x34,0x1B,0x73,0xA8,0xCF,0x18,0xE3,0x66,0x73,0xDF,0xA4,0x52,0x03,0x71,0xE0,0xE3,0x9F,0x31,0x1A,0xA5,0xB6,0xA8,0x7B,0xC7,0x21,0x40,0x05,0xD4,0xE6,0x0B,0x0D,0xBD,0x19,0xE2,0x8D,0xF7,0x88,0xD2,0xD6,0x05,0xB3,0x17,0xA6,0xE1,0xB3,0x3D,0x92,0xB0,0x65,0xB3,0xDE,0xA0,0x08,0x03,0x20,0x6E,0xAF,0xF0,0x96,0xE7,0x7A,0xCF,0x12,0xC0,0x32,0x5A,0x33,0x3F,0xFF,0xD9
                    });
                }
            }

            Profiler.EndSample();

            await newSocket.EmitStringAsJSONAsync("Bridge", new JSONObject(packetData).ToString()); // Write data to server
        }
        catch (System.ObjectDisposedException)
        {
            // This is now expected during shutdown. Silence it.
            Debug.Log("Send aborted: Socket was disposed.");
        }
        catch (System.Exception ex)
        {
            // Catch-all for WebSocket 'Aborted' states
            Debug.LogWarning($"Socket send failed: {ex.Message}");
        }
        finally
        {
            sendingPacket = false;
        }
    }
}